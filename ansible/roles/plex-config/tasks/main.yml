---
# Validate Plex container configuration
- name: Check if Docker is installed
  command: docker --version
  register: docker_version
  changed_when: false

- name: Display Docker version
  debug:
    msg: "Docker version: {{ docker_version.stdout }}"

- name: Check for Plex container
  command: docker ps --filter name=plex --format '{% raw %}{{.Names}}{% endraw %}'
  register: plex_container
  changed_when: false

- name: Verify Plex container exists
  assert:
    that:
      - plex_container.stdout != ""
    fail_msg: "Plex container not found. Please ensure Plex is running."
    success_msg: "Plex container found: {{ plex_container.stdout }}"

- name: Inspect Plex container port mappings
  command: docker port {{ plex_container.stdout }}
  register: plex_ports
  changed_when: false
  when: plex_container.stdout != ""

- name: Display Plex port mappings
  debug:
    msg: "{{ plex_ports.stdout_lines }}"
  when: plex_container.stdout != ""

- name: Verify Plex port 32400 is published
  assert:
    that:
      - "'32400' in plex_ports.stdout"
    fail_msg: "Plex port 32400 is not published. Please check Docker run command."
    success_msg: "Plex port 32400 is correctly published."
  when: plex_container.stdout != ""

- name: Test Plex web interface locally
  uri:
    url: http://localhost:32400/web
    method: GET
    status_code: 200
  register: plex_health
  retries: 3
  delay: 5
  until: plex_health.status == 200

- name: Inspect Plex container network mode
  command: docker inspect {{ plex_container.stdout }} --format '{% raw %}{{.HostConfig.NetworkMode}}{% endraw %}'
  register: plex_network_mode
  changed_when: false
  when: plex_container.stdout != ""

- name: Display Plex network mode
  debug:
    msg: "Plex network mode: {{ plex_network_mode.stdout }}"
  when: plex_container.stdout != ""

- name: Verify Plex is using bridge network (not host)
  assert:
    that:
      - plex_network_mode.stdout != "host"
      - "'bridge' in plex_network_mode.stdout or 'default' in plex_network_mode.stdout"
    fail_msg: "Plex container is using host network mode. This configuration requires bridge mode for WireGuard compatibility."
    success_msg: "Plex container is correctly using bridge network mode."
  when: plex_container.stdout != ""

# Enable IP forwarding for WireGuard tunnel integration
- name: Enable IPv4 forwarding in sysctl
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes

- name: Verify IP forwarding is enabled
  command: sysctl net.ipv4.ip_forward
  register: ip_forward_status
  changed_when: false

- name: Display IP forwarding status
  debug:
    msg: "{{ ip_forward_status.stdout }}"
